import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import numpy as np

st.set_page_config(page_title="Segmentaci√≥n de Hogares", page_icon="üé≠", layout="wide")

# --- Funci√≥n de Carga de Datos ---
@st.cache_data
def cargar_datos_comparacion():
    data = {
        'Perfil': [
            "Aislamiento Rural Profundo", "Conectividad Precaria en el Campo",
            "Pobreza Urbana Informal y Conectada", "Formales pero Vulnerables",
            "Conectados con Acceso a Salud"
        ],
        '2018': [38.40, 4.86, 16.48, 2.27, 37.98],
        '2024': [14.43, 31.70, 34.23, 2.97, 16.68],
        'Cambio': [14.43-38.40, 31.70-4.86, 34.23-16.48, 2.97-2.27, 16.68-37.98],
        'Conectividad': ['Nula', 'Alta', 'Alta', 'Media', 'Alta'],
        'Ubicaci√≥n': ['Rural', 'Rural', 'Urbana', 'Mixta', 'Rural'],
        'Prioridad_Pol√≠tica': ['Cr√≠tica', 'Media', 'Media', 'Baja', 'Media']
    }
    df_comparacion = pd.DataFrame(data)
    return df_comparacion

# --- T√≠tulo y Contexto ---
st.title('üé≠ Los 5 Rostros de la Pobreza Extrema y su Transformaci√≥n')
st.markdown("""
**Utilizando t√©cnicas de Machine Learning (K-Means Clustering), identificamos 5 arquetipos distintos dentro de los hogares en pobreza extrema.**  
La realidad de 2024 muestra una reconfiguraci√≥n dram√°tica: la pobreza ya no es sin√≥nimo de desconexi√≥n digital.
""")

# --- Cargar Datos ---
df_comp = cargar_datos_comparacion()

# --- INDICADORES CLAVE DE TRANSFORMACI√ìN ---
st.header('üìä La Gran Reconfiguraci√≥n en N√∫meros')

col1, col2, col3, col4 = st.columns(4)

with col1:
    st.metric(
        "Hogares Digitalmente Conectados", 
        "82.6%", 
        "+65.8 pp vs 2018",
        help="Suma de perfiles con conectividad Alta o Media"
    )

with col2:
    st.metric(
        "Mayor Grupo: Urbano Informal", 
        "34.2%",
        "+17.8 pp",
        help="El perfil que m√°s creci√≥"
    )

with col3:
    st.metric(
        "Aislamiento Profundo", 
        "14.4%",
        "-24.0 pp",
        help="Reducci√≥n del grupo m√°s vulnerable"
    )

with col4:
    st.metric(
        "Nuevos Rurales Conectados", 
        "31.7%",
        "+26.8 pp",
        help="Emergen rurales con celular pero sin servicios"
    )

st.markdown("---")

# --- VISUALIZACI√ìN PRINCIPAL: TRANSFORMACI√ìN ---
st.header('üîÑ La Transformaci√≥n de Perfiles (2018 ‚Üí 2024)', divider='blue')

# Crear un gr√°fico m√°s sofisticado con flujos
col1, col2 = st.columns([3, 1])

with col1:
    # Gr√°fico de barras con colores por cambio
    df_comp['Color'] = df_comp['Cambio'].apply(
        lambda x: 'Crecimiento' if x > 10 else 'Decrecimiento' if x < -10 else 'Estable'
    )
    
    # Preparar datos para gr√°fico
    df_grafico = df_comp.melt(
        id_vars=['Perfil', 'Color'], 
        value_vars=['2018', '2024'], 
        var_name='A√±o', 
        value_name='Porcentaje'
    )
    
    fig = px.bar(df_grafico, 
                 x='Perfil', 
                 y='Porcentaje', 
                 color='A√±o',
                 barmode='group',
                 text_auto='.1f',
                 title='Evoluci√≥n Dram√°tica de los Perfiles de Pobreza Extrema',
                 color_discrete_map={'2018': '#ff7f0e', '2024': '#1f77b4'},
                 height=500)
    
    fig.update_traces(textposition='outside')
    fig.update_layout(
        xaxis_tickangle=-45,
        xaxis_title="",
        yaxis_title="Porcentaje de Hogares (%)",
        showlegend=True
    )
    
    # A√±adir l√≠neas de conexi√≥n para mostrar el cambio
    for i, row in df_comp.iterrows():
        fig.add_shape(
            type="line",
            x0=i-0.2, y0=row['2018'],
            x1=i+0.2, y1=row['2024'],
            line=dict(color="gray", width=1, dash="dot"),
        )
    
    st.plotly_chart(fig, use_container_width=True)

with col2:
    st.markdown("""
    ### üéØ **Cambios Clave**
    
    **üìà Grandes Ganadores:**
    - Urbanos Informales: +17.8pp
    - Rurales Conectados: +26.8pp
    
    **üìâ Gran Perdedor:**
    - Aislamiento Rural: -24.0pp
    
    **‚öñÔ∏è Estables:**
    - Formales: +0.7pp
    - Con Salud: -21.3pp
    
    **üí° Insight:**
    La conectividad digital transform√≥ m√°s la pobreza rural que la urbana.
    """)

# --- MATRIZ DE PERFILES ---
st.header('üó∫Ô∏è Mapa de Perfiles: Caracter√≠sticas y Oportunidades', divider='green')

# Crear datos expandidos para la matriz
perfiles_detalle = {
    'Perfil': [
        "üî¥ Aislamiento Rural Profundo",
        "üü¢ Conectividad Precaria en el Campo", 
        "üîµ Pobreza Urbana Informal y Conectada",
        "üü£ Formales pero Vulnerables",
        "üü° Conectados con Acceso a Salud"
    ],
    'Tama√±o_2024': [14.4, 31.7, 34.2, 3.0, 16.7],
    'Cambio': [-24.0, +26.8, +17.8, +0.7, -21.3],
    'Conectividad_Digital': ["‚ùå Nula", "‚úÖ Total", "‚úÖ Total", "üü° Media", "‚úÖ Total"],
    'Principal_Carencia': ["Todo", "Salud/Seg.Social", "Seg.Social", "Ingresos", "Vivienda"],
    'Estrategia_Sugerida': ["Presencial", "Telemedicina", "Emp. Digital", "Mejora Salarial", "Infraestructura"],
    'Prioridad': ["üî• Cr√≠tica", "üìã Media", "üìã Media", "üîµ Baja", "üìã Media"]
}

df_matriz = pd.DataFrame(perfiles_detalle)

# Mostrar como tabla interactiva
st.dataframe(
    df_matriz,
    column_config={
        "Perfil": st.column_config.TextColumn("Perfil de Hogar", width="medium"),
        "Tama√±o_2024": st.column_config.NumberColumn("% en 2024", format="%.1f%%"),
        "Cambio": st.column_config.NumberColumn("Cambio vs 2018", format="%+.1f pp"),
        "Conectividad_Digital": st.column_config.TextColumn("Conectividad"),
        "Principal_Carencia": st.column_config.TextColumn("Principal Carencia"),
        "Estrategia_Sugerida": st.column_config.TextColumn("Estrategia Sugerida"),
        "Prioridad": st.column_config.TextColumn("Prioridad Pol√≠tica")
    },
    hide_index=True,
    use_container_width=True
)

st.markdown("---")

# --- DESCRIPCIONES DETALLADAS ---
st.header('üë• Conoce a cada Perfil: Historias detr√°s de los N√∫meros', divider='orange')

# Crear tabs para cada perfil
tabs = st.tabs([
    "üîµ Urbano Informal (34.2%)",
    "üü¢ Rural Conectado (31.7%)", 
    "üü° Con Salud (16.7%)",
    "üî¥ Aislamiento Rural (14.4%)",
    "üü£ Formales (3.0%)"
])

with tabs[0]:
    col1, col2 = st.columns([2, 1])
    with col1:
        st.markdown("""
        ### üîµ **Pobreza Urbana Informal y Conectada** | El Nuevo Rostro Mayoritario
        
        **üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Qui√©nes son:**  
        Familias urbanas con los ingresos m√°s altos dentro de la pobreza extrema. Trabajadores informales, comerciantes, empleados sin prestaciones.
        
        **üí™ Fortalezas:**
        - ‚úÖ Acceso casi universal a celular e internet
        - ‚úÖ Mejores condiciones de vivienda 
        - ‚úÖ Acceso a servicios b√°sicos urbanos
        - ‚úÖ Mayor movilidad social potencial
        
        **‚ö†Ô∏è Principal Vulnerabilidad:**  
        **Nula seguridad social** - No tienen acceso a servicios m√©dicos, prestaciones laborales, o pensiones
        
        **üöÄ Oportunidad de Pol√≠tica P√∫blica:**
        - Apps para formalizaci√≥n laboral simplificada
        - Plataformas digitales de capacitaci√≥n t√©cnica
        - Marketplace digital para micro y peque√±os negocios
        - Seguro popular universal via app
        """)
    with col2:
        # Mini gr√°fico del perfil
        fig_perfil1 = go.Figure(go.Indicator(
            mode = "gauge+number",
            value = 34.2,
            title = {'text': "% del Total<br>Pobreza Extrema"},
            gauge = {
                'axis': {'range': [None, 40]},
                'bar': {'color': "#1f77b4"},
                'steps': [{'range': [0, 20], 'color': "lightgray"},
                         {'range': [20, 35], 'color': "yellow"}],
                'threshold': {'line': {'color': "red", 'width': 4},
                            'thickness': 0.75, 'value': 30}}))
        fig_perfil1.update_layout(height=250)
        st.plotly_chart(fig_perfil1, use_container_width=True)
        
        st.metric("Cambio vs 2018", "+17.8 pp", "üíπ Mayor crecimiento")

with tabs[1]:
    col1, col2 = st.columns([2, 1])
    with col1:
        st.markdown("""
        ### üü¢ **Conectividad Precaria en el Campo** | La Revoluci√≥n Rural Conectada
        
        **üë®‚Äçüåæ Qui√©nes son:**  
        El nuevo rostro de la pobreza rural. Han adoptado masivamente el celular como su ventana al mundo, pero siguen aislados de servicios presenciales.
        
        **üí™ Fortalezas:**
        - ‚úÖ Adopci√≥n total del celular (100% pr√°cticamente)
        - ‚úÖ Capacidad de adaptaci√≥n tecnol√≥gica sorprendente
        - ‚úÖ Potencial para servicios remotos
        
        **‚ö†Ô∏è Principal Vulnerabilidad:**  
        **Carencia total de acceso a salud** - Viven en comunidades sin centros de salud, hospitales, o personal m√©dico
        
        **üöÄ Oportunidad de Pol√≠tica P√∫blica:**
        - Telemedicina via WhatsApp/SMS
        - Informaci√≥n agropecuaria por mensajer√≠a
        - Educaci√≥n a distancia para adultos
        - Pagos digitales para programas sociales
        - Marketplace rural para productos locales
        """)
    with col2:
        fig_perfil2 = go.Figure(go.Indicator(
            mode = "gauge+number",
            value = 31.7,
            title = {'text': "% del Total<br>Pobreza Extrema"},
            gauge = {
                'axis': {'range': [None, 40]},
                'bar': {'color': "#2ca02c"},
                'steps': [{'range': [0, 15], 'color': "lightgray"},
                         {'range': [15, 30], 'color': "yellow"}],
                'threshold': {'line': {'color': "red", 'width': 4},
                            'thickness': 0.75, 'value': 25}}))
        fig_perfil2.update_layout(height=250)
        st.plotly_chart(fig_perfil2, use_container_width=True)
        
        st.metric("Cambio vs 2018", "+26.8 pp", "üöÄ Explosi√≥n digital rural")

with tabs[2]:
    col1, col2 = st.columns([2, 1])
    with col1:
        st.markdown("""
        ### üü° **Conectados con Acceso a Salud** | Salud S√≠, Servicios No
        
        **üè• Qui√©nes son:**  
        Hogares rurales que han sido alcanzados por programas de salud p√∫blica, pero viven en condiciones de infraestructura muy precarias.
        
        **üí™ Fortalezas:**
        - ‚úÖ Conectados digitalmente 
        - ‚úÖ Cobertura de salud garantizada
        - ‚úÖ Beneficiarios de programas focalizados
        
        **‚ö†Ô∏è Principal Vulnerabilidad:**  
        **Las peores condiciones de servicios b√°sicos** - Sin agua potable, drenaje, o electricidad confiable
        
        **üöÄ Oportunidad de Pol√≠tica P√∫blica:**
        - Apps para reportar fallas en servicios b√°sicos
        - Comunicaci√≥n digital sobre programas de vivienda
        - Coordinaci√≥n remota de brigadas de infraestructura
        - Educaci√≥n digital sobre higiene y saneamiento
        """)
    with col2:
        fig_perfil3 = go.Figure(go.Indicator(
            mode = "gauge+number",
            value = 16.7,
            title = {'text': "% del Total<br>Pobreza Extrema"},
            gauge = {
                'axis': {'range': [None, 40]},
                'bar': {'color': "#ffbb78"},
                'steps': [{'range': [0, 10], 'color': "lightgray"},
                         {'range': [10, 20], 'color': "yellow"}],
                'threshold': {'line': {'color': "red", 'width': 4},
                            'thickness': 0.75, 'value': 20}}))
        fig_perfil3.update_layout(height=250)
        st.plotly_chart(fig_perfil3, use_container_width=True)
        
        st.metric("Cambio vs 2018", "-21.3 pp", "üìâ Grupo en transici√≥n")

with tabs[3]:
    col1, col2 = st.columns([2, 1])
    with col1:
        st.markdown("""
        ### üî¥ **Aislamiento Rural Profundo** | El N√∫cleo Duro de la Exclusi√≥n
        
        **üèöÔ∏è Qui√©nes son:**  
        El grupo m√°s vulnerable. Los m√°s pobres entre los pobres. Comunidades completamente aisladas, sin acceso a ning√∫n servicio b√°sico.
        
        **üí™ Fortalezas:**
        - ‚ùå Ninguna evidente en t√©rminos de conectividad o servicios
        - ü§ù Potencialmente, redes comunitarias s√≥lidas
        
        **‚ö†Ô∏è Principal Vulnerabilidad:**  
        **Exclusi√≥n total** - Sin celular, sin servicios, sin ingresos estables, sin esperanza de movilidad social
        
        **üöÄ Oportunidad de Pol√≠tica P√∫blica:**
        - ‚ö†Ô∏è **Las estrategias digitales NO funcionan aqu√≠**
        - Brigadas presenciales de atenci√≥n integral  
        - Programas de primer acceso a dispositivos
        - Infraestructura b√°sica antes que digital
        - Atenci√≥n m√©dica con promotores de salud locales
        """)
    with col2:
        fig_perfil4 = go.Figure(go.Indicator(
            mode = "gauge+number",
            value = 14.4,
            title = {'text': "% del Total<br>Pobreza Extrema"},
            gauge = {
                'axis': {'range': [None, 40]},
                'bar': {'color': "#d62728"},
                'steps': [{'range': [0, 10], 'color': "lightgray"},
                         {'range': [10, 20], 'color': "yellow"}],
                'threshold': {'line': {'color': "red", 'width': 4},
                            'thickness': 0.75, 'value': 20}}))
        fig_perfil4.update_layout(height=250)
        st.plotly_chart(fig_perfil4, use_container_width=True)
        
        st.metric("Cambio vs 2018", "-24.0 pp", "‚úÖ Reducci√≥n exitosa")

with tabs[4]:
    col1, col2 = st.columns([2, 1])
    with col1:
        st.markdown("""
        ### üü£ **Formales pero Vulnerables** | La Paradoja del Trabajo Formal
        
        **üëî Qui√©nes son:**  
        Un nicho peque√±o pero importante: trabajadores formales o pensionados con ingresos tan bajos que no superan la l√≠nea de pobreza extrema.
        
        **üí™ Fortalezas:**
        - ‚úÖ Acceso a seguridad social (IMSS/ISSSTE)
        - ‚úÖ Estabilidad laboral relativa
        - ‚úÖ Derechos laborales protegidos
        
        **‚ö†Ô∏è Principal Vulnerabilidad:**  
        **Salarios de subsistencia** - Trabajan formalmente pero ganan menos del m√≠nimo vital
        
        **üöÄ Oportunidad de Pol√≠tica P√∫blica:**
        - Programas de mejora salarial sectorial
        - Capacitaci√≥n laboral para mejores empleos
        - Complemento alimentario temporal
        - Educaci√≥n financiera y de emprendimiento
        - Programas especiales para jefas de familia
        """)
    with col2:
        fig_perfil5 = go.Figure(go.Indicator(
            mode = "gauge+number",
            value = 3.0,
            title = {'text': "% del Total<br>Pobreza Extrema"},
            gauge = {
                'axis': {'range': [None, 40]},
                'bar': {'color': "#9467bd"},
                'steps': [{'range': [0, 5], 'color': "lightgray"},
                         {'range': [5, 10], 'color': "yellow"}],
                'threshold': {'line': {'color': "red", 'width': 4},
                            'thickness': 0.75, 'value': 5}}))
        fig_perfil5.update_layout(height=250)
        st.plotly_chart(fig_perfil5, use_container_width=True)
        
        st.metric("Cambio vs 2018", "+0.7 pp", "üìä Grupo estable")

# --- S√çNTESIS FINAL ---
st.header('üéØ S√≠ntesis: Una Nueva Era de Pol√≠ticas P√∫blicas Diferenciadas', divider='rainbow')

col1, col2 = st.columns(2)

with col1:
    st.markdown("""
    ### üöÄ **Lo que Cambi√≥ Todo**
    
    **La Revoluci√≥n M√≥vil (2018-2024):**
    - 85% de hogares en pobreza extrema ya est√°n conectados
    - La pobreza ya no es sin√≥nimo de aislamiento digital
    - Emergieron nuevos perfiles h√≠bridos (rurales conectados)
    
    ### üì± **La Nueva Realidad**
    
    **Tres Mundos Digitales:**
    1. **Conectados Productivos** (82%): Listos para servicios digitales
    2. **Aislamiento Residual** (14%): Requieren estrategias presenciales
    3. **Formales Vulnerables** (3%): Necesitan mejora de ingresos
    """)

with col2:
    st.markdown("""
    ### üéØ **Implicaciones para Pol√≠tica P√∫blica**
    
    **Era Pre-Digital (Hasta 2018):**
    - Una sola estrategia: programas presenciales masivos
    - Foco en acceso b√°sico a servicios
    
    **Era Post-Digital (2024 en adelante):**
    - Cinco estrategias diferenciadas por perfil
    - Foco en calidad y uso productivo de la tecnolog√≠a
    - Mix entre digital y presencial seg√∫n el perfil
    
    ### üí° **El Mensaje Clave**
    
    **La pobreza extrema se diversific√≥ y se digitaliz√≥. Las pol√≠ticas p√∫blicas deben hacer lo mismo.**
    """)

st.markdown("""
---
**üî¨ Metodolog√≠a:** An√°lisis de clustering K-Means aplicado a las dimensiones de conectividad, ubicaci√≥n geogr√°fica, acceso a servicios de salud, 
seguridad social, condiciones de vivienda e ingresos. Datos ENIGH 2018-2024, CONEVAL.
""")